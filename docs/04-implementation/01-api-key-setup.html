<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIキーの取得と設定 - 医療機関向け API キー管理マニュアル</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">🔑 APIキーの取得と設定</h1>
                <p class="header-subtitle">医療機関向け API キー管理マニュアル</p>
            </div>
            <div class="header-actions">
                <button onclick="window.print()" class="btn btn-outline">🖨️ 印刷</button>
                <button id="dark-mode-toggle" class="btn btn-outline">🌙</button>
                <a href="../../index.html" class="btn btn-primary">📚 マニュアル目次に戻る</a>
            </div>
        </div>
    </header>

    <div class="container">
        <main class="content" style="max-width: 1200px; margin: 40px auto; grid-column: unset;">
            <h1>APIキーの取得と設定</h1>

            <h2>OpenAIアカウントの作成</h2>

            <h3>🏥 医療機関向けアカウント設定</h3>

            <h4>事前準備</h4>
            <p>医療機関でのOpenAI API利用には、適切なアカウント設定が重要です。</p>

            <h5>必要な情報</h5>
            <div class="card">
                <ul>
                    <li><strong>医療機関名</strong>: 正式な法人名称</li>
                    <li><strong>責任者情報</strong>: 管理者（院長・IT責任者）</li>
                    <li><strong>連絡先</strong>: 代表メールアドレス・電話番号</li>
                    <li><strong>利用目的</strong>: 医療業務での具体的な活用計画</li>
                </ul>
            </div>

            <h5>アカウント種別</h5>
            <div class="card">
                <pre>個人アカウント（非推奨）:
- 個人名での登録
- 個人クレジットカードでの支払い
- 医療機関としての保護が不十分

組織アカウント（推奨）:
- 医療機関名での登録
- 法人カードでの支払い
- 適切なガバナンス体制</pre>
            </div>

            <h3>📝 アカウント作成手順</h3>

            <h4>1. OpenAI公式サイトにアクセス</h4>
            <div class="card">
                <ul>
                    <li>URL: https://platform.openai.com/</li>
                    <li>「Sign up」ボタンをクリック</li>
                </ul>
            </div>

            <h4>2. 基本情報の入力</h4>
            <div class="card">
                <pre>入力項目:
- Email: 医療機関の代表メールアドレス
- Password: 強固なパスワード（大小英数記号12文字以上）
- Organization name: 正式な医療機関名</pre>
            </div>

            <h4>3. メール認証</h4>
            <div class="card">
                <ul>
                    <li>登録メールアドレスに認証メール送信</li>
                    <li>メール内のリンクをクリックして認証完了</li>
                </ul>
            </div>

            <h4>4. 電話番号認証</h4>
            <div class="card">
                <ul>
                    <li>SMS認証による本人確認</li>
                    <li>医療機関の代表番号を推奨</li>
                </ul>
            </div>

            <h2>APIキーの生成</h2>

            <h3>🔑 キー生成の基本手順</h3>

            <h4>1. API Keys ページへアクセス</h4>
            <div class="card">
                <ul>
                    <li>ダッシュボード左メニューから「API Keys」を選択</li>
                    <li>または直接 https://platform.openai.com/api-keys</li>
                </ul>
            </div>

            <h4>2. 新しいキーの作成</h4>
            <div class="card">
                <pre>手順:
1. 「Create new secret key」をクリック
2. キー名を入力（例：「内科外来用」「文書作成用」）
3. 権限設定（通常は「All」を選択）
4. 「Create secret key」をクリック</pre>
            </div>

            <h4>3. キーの保存</h4>
            <div class="alert alert-warning">
                <h5>⚠️ 重要: キーは一度だけ表示されます</h5>
                <pre>表示例:
sk-proj-abcdefghijklmnopqrstuvwxyz1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ

このキーを安全に保存してください。
再表示はできません。</pre>
            </div>

            <h3>🏷️ キーの命名規則</h3>

            <h4>推奨命名パターン</h4>
            <div class="card">
                <pre>部署別:
- naika-gairai-2024（内科外来2024年）
- seikei-2024（整形外科2024年）
- kango-2024（看護部2024年）

用途別:
- bunsho-sakusei（文書作成）
- ronsho-youyaku（論文要約）
- kanja-setsumei（患者説明）

期間別:
- 2024-q1（2024年第1四半期）
- 2024-q2（2024年第2四半期）</pre>
            </div>

            <h2>BAA（Business Associate Agreement）の申請</h2>

            <h3>📋 BAA申請の準備</h3>

            <h4>医療機関の場合、BAA申請を強く推奨</h4>
            <p>BAA（Business Associate Agreement）により、より厳格なデータ保護が提供されます。</p>

            <h4>申請前の準備資料</h4>
            <div class="card">
                <pre>必要書類:
1. 医療機関の概要
   - 正式名称・所在地
   - 診療科目・病床数
   - 年間患者数

2. 利用計画書
   - AI活用の目的・範囲
   - 取り扱うデータの種類
   - セキュリティ対策

3. 責任者情報
   - 管理者の詳細情報
   - IT責任者の詳細情報
   - 緊急連絡先</pre>
            </div>

            <h3>📧 BAA申請手順</h3>

            <h4>1. 申請メール送信</h4>
            <div class="card">
                <pre>宛先: baa@openai.com
件名: BAA Request - [医療機関名]

本文例:
件名: Business Associate Agreement申請

OpenAI様

[医療機関名]の[役職][氏名]と申します。

弊院では、診療業務の効率化を目的として、
OpenAI APIの利用を検討しております。

患者情報の適切な保護のため、
Business Associate Agreement（BAA）の
締結をお願いいたします。

＜医療機関情報＞
- 正式名称: [医療機関名]
- 所在地: [住所]
- 診療科目: [科目]
- 責任者: [氏名・役職]

＜利用目的＞
- 診療記録の作成支援
- 患者説明資料の作成
- 医学文献の要約

ご不明な点がございましたら、
お気軽にお問い合わせください。

よろしくお願いいたします。

[署名]</pre>
            </div>

            <h4>2. 追加情報の提供</h4>
            <div class="card">
                <p>OpenAIから追加情報の要求があった場合、迅速に対応</p>
                <ul>
                    <li>より詳細な利用計画</li>
                    <li>セキュリティ体制の説明</li>
                    <li>技術的な質問への回答</li>
                </ul>
            </div>

            <h4>3. BAA締結</h4>
            <div class="card">
                <ul>
                    <li>通常1-2営業日で初回回答</li>
                    <li>数営業日でBAA締結完了</li>
                    <li>ZDR（Zero Data Retention）オプションの利用可能</li>
                </ul>
            </div>

            <h2>請求・支払い設定</h2>

            <h3>💳 支払い方法の設定</h3>

            <h4>推奨支払い方法</h4>
            <div class="card">
                <pre>法人クレジットカード（推奨）:
- 医療機関名義のクレジットカード
- 利用明細の透明性
- 経理処理の簡素化

請求書支払い:
- 月額$1,000以上の場合利用可能
- 銀行振込での支払い
- 法人会計に適した処理</pre>
            </div>

            <h4>請求設定の手順</h4>
            <div class="card">
                <ol>
                    <li><strong>Billing</strong> ページにアクセス</li>
                    <li><strong>Payment methods</strong> で支払い方法を設定</li>
                    <li><strong>Billing information</strong> で請求先情報を入力</li>
                    <li><strong>Usage limits</strong> で利用上限を設定</li>
                </ol>
            </div>

            <h3>💰 利用上限の設定</h3>

            <h4>予算管理のための制限設定</h4>
            <div class="card">
                <pre>推奨設定例:

小規模診療所:
- 月額上限: $50-100
- 1日上限: $10
- アラート: 80%到達時

中規模病院:
- 月額上限: $200-500
- 1日上限: $50
- アラート: 70%到達時

大規模病院:
- 月額上限: $1,000-5,000
- 1日上限: $200
- アラート: 60%到達時</pre>
            </div>

            <h2>APIキーの実装・設定</h2>

            <h3>🔧 システムへの実装</h3>

            <h4>環境変数での設定（推奨）</h4>
            <div class="card">
                <pre># .env ファイル
OPENAI_API_KEY=sk-proj-your-secret-key-here
OPENAI_ORG_ID=org-your-organization-id

# 環境変数の設定
export OPENAI_API_KEY="sk-proj-your-secret-key-here"</pre>
            </div>

            <h4>アプリケーション設定</h4>
            <div class="card">
                <pre># Python例
import openai

# 環境変数から読み込み（推奨）
openai.api_key = os.getenv("OPENAI_API_KEY")

# 直接指定（非推奨）
# openai.api_key = "sk-proj-..." # セキュリティリスクあり</pre>
            </div>

            <h4>設定ファイル（暗号化必須）</h4>
            <div class="card">
                <pre>// config.json（暗号化必須）
{
  "openai": {
    "api_key": "encrypted_key_here",
    "organization": "org-id-here",
    "max_tokens": 1000,
    "temperature": 0.7
  }
}</pre>
            </div>

            <h3>🛡️ セキュアな実装パターン</h3>

            <h4>1. 環境変数 + 暗号化</h4>
            <div class="card">
                <pre>import os
from cryptography.fernet import Fernet

# 暗号化されたキーの復号化
def decrypt_api_key():
    encrypted_key = os.getenv("ENCRYPTED_OPENAI_KEY")
    key = os.getenv("ENCRYPTION_KEY")
    f = Fernet(key)
    return f.decrypt(encrypted_key.encode()).decode()

# 安全にAPIキーを取得
api_key = decrypt_api_key()</pre>
            </div>

            <h4>2. アクセス制御付きの設定</h4>
            <div class="card">
                <pre>class SecureAPIConfig:
    def __init__(self):
        self._api_key = None
        self._authorized_users = set()
    
    def authorize_user(self, user_id):
        # ユーザー認証ロジック
        if self.verify_user(user_id):
            self._authorized_users.add(user_id)
    
    def get_api_key(self, user_id):
        if user_id in self._authorized_users:
            return self._load_encrypted_key()
        else:
            raise UnauthorizedError("User not authorized")</pre>
            </div>

            <h2>テスト・動作確認</h2>

            <h3>🧪 基本動作テスト</h3>

            <h4>1. 接続テスト</h4>
            <div class="card">
                <pre>import openai

try:
    # 簡単なAPI呼び出し
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": "Hello, this is a test."}],
        max_tokens=10
    )
    print("接続成功:", response.choices[0].message.content)
except Exception as e:
    print("接続エラー:", str(e))</pre>
            </div>

            <h4>2. 権限テスト</h4>
            <div class="card">
                <pre># 利用可能なモデルの確認
models = openai.Model.list()
print("利用可能なモデル:")
for model in models.data:
    print(f"- {model.id}")</pre>
            </div>

            <h4>3. 利用量テスト</h4>
            <div class="card">
                <pre># 少量のテストデータで動作確認
test_messages = [
    "これはテストメッセージです。",
    "APIの動作確認を行っています。",
    "正常に動作していることを確認してください。"
]

for msg in test_messages:
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": msg}],
        max_tokens=50
    )
    print(f"入力: {msg}")
    print(f"出力: {response.choices[0].message.content}\n")</pre>
            </div>

            <h3>📊 監視・ログ設定</h3>

            <h4>利用状況の記録</h4>
            <div class="card">
                <pre>import logging
from datetime import datetime

# ログ設定
logging.basicConfig(
    filename='openai_usage.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def log_api_usage(user_id, model, tokens_used, cost):
    log_entry = {
        'timestamp': datetime.now().isoformat(),
        'user_id': user_id,
        'model': model,
        'tokens': tokens_used,
        'cost': cost
    }
    logging.info(f"API_USAGE: {log_entry}")</pre>
            </div>

            <h2>トラブルシューティング</h2>

            <h3>❗ よくある問題と解決方法</h3>

            <h4>1. 認証エラー</h4>
            <div class="alert alert-danger">
                <pre>エラー: "Incorrect API key provided"

解決方法:
- APIキーの形式確認（sk-proj-で始まる）
- コピー時の余分な文字・空白の削除
- 環境変数の設定確認</pre>
            </div>

            <h4>2. 権限エラー</h4>
            <div class="alert alert-danger">
                <pre>エラー: "You exceeded your current quota"

解決方法:
- 利用上限の確認・増額
- 請求情報の更新
- 支払い方法の確認</pre>
            </div>

            <h4>3. 接続エラー</h4>
            <div class="alert alert-danger">
                <pre>エラー: "Connection timeout"

解決方法:
- ネットワーク接続の確認
- ファイアウォール設定の確認
- プロキシ設定の確認</pre>
            </div>

            <h2>次のステップ</h2>

            <p>APIキーの設定が完了したら、実際の利用方法を確認してください：</p>

            <div class="card-grid">
                <div class="card">
                    <h3>🔗 関連文書</h3>
                    <ul>
                        <li><a href="02-practical-usage.html">実践的な使用ガイド</a></li>
                        <li><a href="../03-security/03-api-key-security.html">セキュリティのベストプラクティス</a></li>
                        <li><a href="../03-security/01-security-overview.html">セキュリティガイドライン概要</a></li>
                    </ul>
                </div>
                
                <div class="card">
                    <h3>📚 マニュアル全体</h3>
                    <ul>
                        <li><a href="../../index.html">マニュアル目次に戻る</a></li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 医療機関向け API キー管理マニュアル. 
            <span class="footer-note">本マニュアルは医療機関での安全なAI活用を支援することを目的としています。</span></p>
        </div>
    </footer>

    <script>
        // ダークモード切り替え
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                darkModeToggle.textContent = newTheme === 'dark' ? '☀️' : '🌙';
            });
        }

        // 保存されたテーマを復元
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
            if (darkModeToggle) {
                darkModeToggle.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            }
        }
    </script>
</body>
</html>