# APIキーセキュリティ

## APIキーの基本理解

### 🔑 APIキーとは
APIキーは、OpenAI APIを利用するための認証情報です。銀行のキャッシュカードと同様に、適切な管理が必要です。

#### APIキーの機能
- **認証**: 利用者の身元確認
- **認可**: 利用可能な機能の制御
- **課金**: 使用量に基づく料金計算
- **監査**: 利用状況の追跡・記録

#### APIキーの形式
```
sk-proj-abcdefghijklmnopqrstuvwxyz1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ
```
- 「sk-proj-」で始まる長い文字列
- 大文字・小文字・数字の組み合わせ
- 一度生成されると変更不可（再生成のみ）

## APIキー管理の重要性

### ⚠️ 不適切な管理によるリスク

#### 不正利用による被害
- **金銭的損失**: 第三者による大量利用で高額請求
- **データ漏洩**: 不正アクセスによる情報流出
- **サービス停止**: アカウント凍結による業務停止
- **法的責任**: 患者情報流出時の損害賠償

#### 具体的な被害事例（想定）
- 月額数万円の予定が数百万円の請求
- 患者情報が外部に送信される事故
- 院内システムが使用不能になる障害
- 報道による医療機関の信頼失墜

### 🛡️ 適切な管理によるメリット
- **安全な利用**: 認可された職員のみの利用
- **コスト管理**: 予算に応じた利用制限
- **監査対応**: 利用状況の透明性確保
- **事故防止**: セキュリティインシデントの予防

## APIキーの安全な管理方法

### 🔒 生成時の注意事項

#### 管理者による一元管理
- **IT責任者**: システム管理者が一括管理
- **最小限の発行**: 必要最小限の数のみ生成
- **用途別発行**: 部署・用途ごとに個別キー
- **定期的な見直し**: 不要なキーの定期削除

#### 生成時の記録
```
APIキー管理台帳の例:
- キーID: key_001
- 発行日: 2024-06-23
- 発行者: IT管理者
- 利用部署: 内科外来
- 利用目的: 診療記録作成支援
- 有効期限: 2024-12-31
- 最終確認日: 2024-06-23
```

### 🗄️ 保存・保管方法

#### ✅ 推奨される保管方法

##### 1. パスワード管理ツール
```
推奨ツール例:
- 1Password
- Bitwarden
- LastPass Business
- Azure Key Vault
```

##### 2. 暗号化された文書
- 暗号化PDFファイル
- 暗号化Excelファイル
- GPG暗号化テキスト

##### 3. 物理的な安全保管
- 金庫での保管
- 施錠された引き出し
- アクセス制限された部屋

#### ❌ 避けるべき保管方法

##### 危険な保管場所
- **平文ファイル**: 暗号化されていないExcel・Word
- **メール**: 社内外メールでの送信・保管
- **チャットツール**: Slack・Teams等での共有
- **クラウドドライブ**: 無暗号化でのクラウド保存
- **付箋・メモ**: 机上・PC画面への貼り付け
- **ブラウザ保存**: Webブラウザの自動保存機能

##### 共有の危険性
```
❌ 悪い例:
「APIキーをメールで送信」
「Slackでキーを共有」
「共有フォルダに平文保存」

✅ 良い例:
「パスワード管理ツールで共有」
「暗号化メールでの送信」
「口頭・電話での伝達」
```

### 🔄 定期的な更新・ローテーション

#### 更新タイミング
- **定期更新**: 3-6ヶ月ごと
- **職員変更時**: 担当者の異動・退職時
- **セキュリティインシデント**: 漏洩疑いがある場合
- **システム変更**: 利用システムの大幅変更時

#### 更新手順
1. **新しいキーの生成**: 既存キーと並行運用
2. **システムの設定変更**: 新キーでのテスト実行
3. **動作確認**: 全機能の正常動作確認
4. **旧キーの無効化**: 既存キーの削除・無効化
5. **記録の更新**: 管理台帳の更新

## アクセス制御と権限管理

### 👥 アクセス権限の設計

#### 職種別権限設定
```
医師：
- 診断支援AI: 参照のみ
- 文書作成AI: 作成・編集可
- 管理機能: アクセス不可

看護師：
- 患者説明資料: 作成・編集可
- 診断支援AI: アクセス不可
- 管理機能: アクセス不可

事務職員：
- 文書作成AI: 限定的利用
- 患者情報AI: アクセス不可
- 管理機能: アクセス不可

IT管理者：
- 全機能: フルアクセス
- 管理機能: 設定・監視可
- 監査機能: ログ確認可
```

#### 時間・場所制限
- **利用時間**: 診療時間内のみ
- **アクセス場所**: 院内ネットワークのみ
- **デバイス制限**: 院内PCのみ利用可
- **VPN接続**: 院外アクセス時の認証

### 🔐 二要素認証の実装

#### 推奨される認証方法
1. **SMS認証**: 携帯電話への認証コード送信
2. **認証アプリ**: Google Authenticator、Microsoft Authenticator
3. **ハードウェアトークン**: YubiKey等の物理デバイス
4. **生体認証**: 指紋・顔認証（デバイス対応時）

#### 実装例
```
ログイン手順:
1. ユーザーID・パスワード入力
2. 二要素認証コード入力
3. APIキーの自動取得・設定
4. 利用ログの自動記録
```

## 利用状況の監視・監査

### 📊 ログ監視システム

#### 監視すべき項目
- **利用時刻**: アクセス日時・利用時間
- **利用者**: ユーザーID・担当者名
- **利用内容**: 使用した機能・サービス
- **データ量**: 送受信したデータサイズ
- **コスト**: 利用料金・累積費用

#### 異常検知アラート
```
アラート設定例:
- 時間外利用（診療時間外のアクセス）
- 大量利用（通常の10倍以上の利用）
- 異常な場所（院外からのアクセス）
- 連続失敗（パスワード間違い等）
- 高額利用（月額予算の50%超過）
```

### 📈 定期的な監査

#### 月次監査項目
- [ ] APIキー利用状況の確認
- [ ] 不正アクセスの有無確認
- [ ] 利用コストの妥当性評価
- [ ] 職員の利用パターン分析

#### 四半期監査項目
- [ ] APIキーの棚卸し・見直し
- [ ] アクセス権限の適切性確認
- [ ] セキュリティポリシーの遵守状況
- [ ] 教育効果の測定・評価

## インシデント対応

### 🚨 APIキー漏洩時の対応

#### 緊急対応（24時間以内）
1. **キーの無効化**: 該当キーの即座な削除
2. **影響範囲の調査**: 利用状況・アクセスログの確認
3. **一時停止**: 関連システムの利用停止
4. **報告**: 管理者・責任者への報告

#### 短期対応（1週間以内）
1. **新キーの発行**: セキュアな環境での再生成
2. **システム復旧**: 新キーでの動作確認・復旧
3. **原因調査**: 漏洩経路・原因の特定
4. **再発防止策**: 対策の検討・実装

#### 長期対応（1ヶ月以内）
1. **セキュリティ強化**: 管理体制の見直し・改善
2. **教育実施**: 職員への再教育・研修
3. **監査強化**: 監視・監査体制の強化
4. **文書化**: 事故記録・対策の文書化

### 🔍 疑わしい活動の検知

#### 注意すべき兆候
- **予期しない高額請求**: 通常の利用料金を大幅に超過
- **異常なアクセスパターン**: 深夜・休日の大量利用
- **不正なIPアドレス**: 院外・海外からのアクセス
- **エラー率の増加**: 認証失敗・API呼び出し失敗

#### 対応手順
1. **即座の一時停止**: 疑わしいキーの利用停止
2. **詳細調査**: ログ・アクセス履歴の詳細分析
3. **影響評価**: 患者情報・業務への影響評価
4. **適切な対応**: 状況に応じた対策実施

## セキュリティ教育・研修

### 👨‍🏫 職員教育プログラム

#### 基礎研修（全職員対象）
- APIキーの基本概念
- 適切な取り扱い方法
- 禁止事項・注意点
- インシデント報告手順

#### 専門研修（管理者・IT担当者）
- 技術的なセキュリティ対策
- ログ監視・分析方法
- インシデント対応手順
- 最新セキュリティ動向

### 📚 継続的な教育

#### 定期的な情報共有
- セキュリティニュースの共有
- 業界事例の紹介
- 院内ポリシーの更新周知
- 質疑応答・意見交換

## 次のステップ

- [インシデント対応手順](./04-incident-response.md)
- [APIキーの取得と設定](../04-implementation/01-api-key-setup.md)
- [実践的な使用ガイド](../04-implementation/02-practical-usage.md)